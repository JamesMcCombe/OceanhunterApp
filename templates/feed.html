{% extends 'base.html' %}

{% load staticfiles sekizai_tags thumbnail %}

{% block header %}
  {# remove footer #}
{% endblock header %}

{% block footer %}
  {# remove footer #}
{% endblock footer %}

{% block nav_title %}{% endblock nav_title %}

{% block content %}

{% addtoblock 'body-class' %} page-feed {% endaddtoblock %}

<ul class="small-block-grid-1 feeds">
  {% for f in feeds %}
    <li class="feed row fish-{{ f.id }}">
      <h3 class="columns small-12 small-centered"><a href="#">{{ f.user.first_name }} {{ f.user.last_name }}</a></h3>
      <a class="image-wrapper" href="#">
        {% thumbnail f.image "640x640" crop="center" as im %}<img class="fish-image" src="{{ im.url }}">{% endthumbnail %}
        <div class="row collapse summaries">
          <div class="columns small-6 text-center">{{ f.species.name }}</div>
          <div class="columns small-3 text-center">{{ f.weight }} Kg</div>
          <div class="columns small-3 text-center">{{ f.points }} Pts</div>
        </div>
      </a>
      <ul class="comments columns small-12 small-centered">
        {% for c in f.comment_set.all %}
          <li class="comment">
            <a class="name" href="#">{{ c.user.first_name }} {{ c.user.last_name }}</a> | <span class="content">{{ c.content }}</span>
          </li>
        {% endfor %}
        <li class="actions">
          <a href="#" class="expand">See all {{ f.comment_set.count }} comments</a>
          <a href="#" class="more" data-reveal-id="feedModal" data-fish-id="{{ f.id }}"> <small>&#8226;&#8226;&#8226;</small> </a>
        </li>
        <li class="new-comment">
          <form>
          <input type="hidden" name="fish_id" value="{{ f.id }}">
          <div class="row collapse">
            <div class="small-10 columns" style="padding-right: 2px;">
              <input type="text" name="content" placeholder="Write a comment...">
            </div>
            <div class="small-2 columns">
              <input type="submit" class="button postfix" value="OK">
            </div>
          </div>
          </form>
        </li>
      </ul>
    </li>
  {% endfor %}
</ul>


<div id="feedModal" class="reveal-modal oc-reveal-modal feed-reveal-modal collapse" data-reveal data-options="animation:fade" data-css-top="100">
  <div class="row">
    <div class="columns small-12">
      <h2 data-title-origin="More">More</h2>
    </div>
  </div>
  <div class="row actions">
    <div class="columns small-4 text-center action comment" data-action data-title="Comment"></div>
    <div class="columns small-4 text-center action delete" data-action data-title="Delete"></div>
    {# <div class="columns small-4 text-center action edit" data-action data-title="Edit"></div> #}
    <div class="columns small-4 text-center action share" data-action data-title="Share"></div>
  </div>
  <a class="close-reveal-modal">&#215;</a>
</div>


{% addtoblock 'js' %}
<script>
  $(function() {
    // to know which menu the user click
    var modal_action_fish_id = null;
    $('body').on('click', '.comments .more', function(e) {
      var btn = $(this);
      modal_action_fish_id = btn.data('fish-id');
    });

    // click comment button on reveal modal
    $('body').on('click', '[data-action].comment', function(e) {
      $('#feedModal').foundation('reveal', 'close');
      $('.fish-'+modal_action_fish_id).find('.new-comment').show().find('[name="content"]').focus();
    });

    $('body').on('submit', '.new-comment form', function(e) {
      e.preventDefault();

      var f = $(this);
      var csrftoken = $.cookie('csrftoken');
      var input_elm = f.find('[name="content"]');
      var content = $.trim(input_elm.val());
      var fish_id = f.find('[name="fish_id"]').val();

      if (content.length == 0) { return; }

      var payload = {
        csrfmiddlewaretoken: csrftoken,
        content: content,
        fish: fish_id
      };

      // display new comment before actually post to backend
      var new_comment_elm = $('<li class="comment"><a class="name" href="#"></a> | <span class="content"></span></li>');
      new_comment_elm
        .find('a').text(OC.user.first_name + ' ' + OC.user.last_name).end()
        .find('span').text(content);

      var after_elm = f.closest('.comments').find('.actions');
      new_comment_elm.insertBefore(after_elm);

      // clear content, hide the input
      input_elm.blur().val('').closest('.new-comment').hide();

      $.ajax({
        url: "{% url 'ajax_new_comment' %}",
        method: 'POST',
        data: payload
      }).success(function(data) {
        if (data.status == 'success') {
        }
      });
    });

  });
</script>
{% endaddtoblock %}

{% endblock content %}
